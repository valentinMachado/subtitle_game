<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Joueur - Sous-Titres</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      html,
      body {
        height: 100%;
        overflow: hidden;
        overscroll-behavior: none;
        margin: 0;
      }
      * {
        box-sizing: border-box;
      }
      h1 {
        text-align: center;
        font-size: 1.2rem;
        margin-bottom: 12px;
      }

      #videoContainer {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 38vh;
        background: black;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }
      #video {
        max-height: 100%;
        max-width: 100%;
        width: auto;
        height: inherit;
        object-fit: contain;
      }
      @media (orientation: landscape) {
        #videoContainer,
        #video {
          max-height: 55vh;
        }
      }

      #subtitleOverlay {
        position: absolute;
        bottom: 12%;
        left: 6%;
        right: 6%;
        text-align: center;
        color: white;
        font-size: 20px;
        background: rgba(0, 0, 0, 0.65);
        padding: 10px 14px;
        border-radius: 8px;
        z-index: 200;
        pointer-events: none;
      }

      #subtitleForm {
        position: fixed;
        bottom: env(safe-area-inset-bottom);
        left: 0;
        right: 0;
        background: white;
        padding: 10px 12px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 300;
      }
      #subtitleForm div {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      button {
        width: 100%;
        max-width: 400px;
        padding: 14px;
        font-size: 16px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      #subtitlesList {
        position: fixed;
        top: 38vh;
        bottom: 76px;
        left: 0;
        right: 0;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0 8px;
        background: #f5f5f5;
        -webkit-overflow-scrolling: touch;
      }
      .subtitleItem {
        display: flex;
        align-items: center;
        gap: 4px;
        min-width: 0;
        background: white;
        border-radius: 6px;
        padding: 6px 8px;
        margin-bottom: 8px;
        border-left: 4px solid transparent;
        cursor: pointer;
      }
      .subtitleItem.active {
        background: #e3f2fd;
        border-left: 4px solid #4caf50;
      }
      .subtitleTime {
        font-size: 0.75rem;
        color: #666;
        margin: 0;
        flex-shrink: 0;
      }
      .subtitleInput {
        flex: 1;
        min-width: 0;
      }
      .seekButton {
        flex-shrink: 0;
        padding: 2px 4px;
        font-size: 0.75rem;
        line-height: 1;
        width: 30px;
      }

      @media (min-width: 768px) {
        body {
          padding: 20px;
        }
        h1 {
          font-size: 1.5rem;
        }
        #video {
          max-height: 50vh;
        }
        .subtitleItem {
          gap: 10px;
        }
        .subtitleTime {
          width: 140px;
          margin-bottom: 0;
        }
      }
    </style>
  </head>
  <body>
    <h1>Soumets tes sous-titres</h1>
    <div id="videoContainer">
      <video id="video" controls></video>
      <div id="subtitleOverlay"></div>
    </div>

    <div id="subtitleForm">
      <div>
        <button id="submitButton" disabled>
          Soumettre tous les sous-titres
        </button>
        <span style="font-size: 0.9rem; color: #333">{{PLAYER_NAME}}</span>
      </div>
    </div>

    <div id="subtitlesList"></div>

    <script>
      const main = async () => {
        const video = document.getElementById("video");
        const subtitleOverlay = document.getElementById("subtitleOverlay");
        const subtitlesList = document.getElementById("subtitlesList");
        const submitButton = document.getElementById("submitButton");

        let videosById = {};
        let playerSubtitles = [];
        let playerName = "";
        let currentVideoId = null;
        let isEditingSubtitle = false;

        // Charger config
        await fetch("/config.json")
          .then((r) => r.json())
          .then((cfg) => {
            videosById = Object.fromEntries(cfg.videos.map((v) => [v.id, v]));
          });

        const socket = io();

        socket.on("connect", () => {
          playerName = prompt(
            "Quel est ton pseudo ?",
            "Joueur " + Math.floor(Math.random() * 1000)
          );
          document.title = `Joueur - ${playerName}`;
          document.querySelector("h1").textContent = `Bienvenue ${playerName}`;
          document.querySelector("#subtitleForm span").textContent = playerName;
          socket.emit("register", { role: "player", playerName });
        });

        socket.on("gameState", (state) => {
          const videoConfig = videosById[state.video.id];
          if (!videoConfig || currentVideoId === state.video.id) return;

          currentVideoId = state.video.id;
          loadVideo(videoConfig);
        });

        function loadVideo(videoConfig) {
          video.src = videoConfig.path;
          video.load();
          playerSubtitles =
            videoConfig.subtitles?.map((s) => ({ ...s, text: "" })) || [];
          renderSubtitlesList();

          // Désactive le submit si un sous-titre est vide
          submitButton.disabled = !playerSubtitles.every(
            (s) => s.text.trim() !== ""
          );
        }

        function renderSubtitlesList() {
          subtitlesList.innerHTML = playerSubtitles
            .map(
              (sub, index) => `
        <div class="subtitleItem" id="subtitle-${index}" data-start="${
                sub.start
              }">
          <span class="subtitleTime">${formatTime(sub.start)} - ${formatTime(
                sub.end
              )}</span>
          <input type="text" class="subtitleInput" placeholder="${
            sub.placeholder
          }" value="${sub.text}"
            onfocus="focusSubtitle(${index}); hideOtherSubtitles(${index});"
            onblur="isEditingSubtitle=false; showAllSubtitles();"
            oninput="updateSubtitleText(${index}, this.value)">
          <button class="seekButton" onclick="seekToSubtitle(${
            sub.start
          })">▶</button>
        </div>
      `
            )
            .join("");
        }

        // === Keep hide/show behavior ===
        function hideOtherSubtitles(focusIndex) {
          document.querySelectorAll(".subtitleItem").forEach((el, i) => {
            el.style.display = i === focusIndex ? "flex" : "none";
          });
        }
        function showAllSubtitles() {
          document
            .querySelectorAll(".subtitleItem")
            .forEach((el) => (el.style.display = "flex"));
        }

        function focusSubtitle(index) {
          const sub = playerSubtitles[index];
          if (!sub) return;
          video.pause();
          isEditingSubtitle = true;
          seekToSubtitle(sub.start);
          setTimeout(() => {
            document
              .getElementById(`subtitle-${index}`)
              ?.scrollIntoView({ behavior: "smooth", block: "end" });
          }, 1000);
        }

        function seekToSubtitle(time) {
          video.currentTime = Math.min(video.duration, time + 0.1);
          updateSubtitleOverlay();
          if (!video.paused) video.play().catch(() => {});
        }

        function updateSubtitleText(index, text) {
          playerSubtitles[index].text = text;

          // Désactive le bouton si un sous-titre est vide
          submitButton.disabled = !playerSubtitles.every(
            (s) => s.text.trim() !== ""
          );

          const sub = playerSubtitles[index];
          if (sub) {
            subtitleOverlay.textContent = text || sub.placeholder;
            subtitleOverlay.style.display = "block";
          }
        }

        function updateSubtitleOverlay() {
          const time = video.currentTime;
          const active = playerSubtitles.find(
            (s) => time >= s.start && time <= s.end
          );
          if (active) {
            subtitleOverlay.textContent = active.text || active.placeholder;
            subtitleOverlay.style.display = "block";
          } else subtitleOverlay.style.display = "none";

          playerSubtitles.forEach((s, i) => {
            document
              .getElementById(`subtitle-${i}`)
              ?.classList.toggle("active", s === active);
          });

          if (!isEditingSubtitle && active) {
            document
              .getElementById(`subtitle-${playerSubtitles.indexOf(active)}`)
              ?.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }

        submitButton.addEventListener("click", () => {
          socket.emit("submitSubtitles", playerSubtitles);
          submitButton.disabled = true;
          submitButton.textContent = "Sous-titres soumis ! ✅";
        });

        video.addEventListener("timeupdate", updateSubtitleOverlay);

        function formatTime(sec) {
          const date = new Date(0);
          date.setSeconds(sec);
          return date.toISOString().substr(11, 8);
        }

        // Expose functions pour inline handlers
        window.focusSubtitle = focusSubtitle;
        window.hideOtherSubtitles = hideOtherSubtitles;
        window.showAllSubtitles = showAllSubtitles;
        window.updateSubtitleText = updateSubtitleText;
        window.seekToSubtitle = seekToSubtitle;
      };

      main();
    </script>
  </body>
</html>
