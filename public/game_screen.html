<!DOCTYPE html>
<html>
  <head>
    <title>Écran de Jeu</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background-color: black;
        font-family: Arial, sans-serif;
      }

      #videoContainer {
        width: 100%;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: black;
        position: relative;
      }

      #video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      #subtitleOverlay {
        position: absolute;
        bottom: 15%;
        left: 0;
        right: 0;
        text-align: center;
        color: white;
        text-shadow: 2px 2px 4px black;
        font-size: 28px;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 15px;
        margin: 0 10%;
        border-radius: 10px;
        display: none;
      }

      #playersContainer {
        position: fixed;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 5px;
        max-width: 300px;
        max-height: 80vh;
        overflow-y: auto;
        color: white;
      }

      .playerItem {
        padding: 8px;
        margin: 5px 0;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        cursor: pointer;
      }

      .playerItem.submitted {
        background-color: rgba(76, 175, 80, 0.3);
      }

      .playerItem.selected {
        background-color: rgba(255, 165, 0, 0.5);
      }
    </style>
  </head>
  <body>
    <div id="videoContainer">
      <video id="video"></video>
      <div id="subtitleOverlay"></div>
    </div>

    <div id="playersContainer">
      <h3>Joueurs connectés</h3>
      <div id="playersList"></div>
    </div>

    <script>
      const main = async () => {
        const subtitleOverlay = document.getElementById("subtitleOverlay");
        const playersList = document.getElementById("playersList");
        const video = document.querySelector("video");

        const socket = io();

        let applyingRemoteChange = false;
        let lastGameState = null;
        let lastAppliedVideoState = { index: null, playing: null, time: null };
        let videosById = {};

        // --- Load config ---
        await fetch("/config.json")
          .then((r) => r.json())
          .then((cfg) => {
            videosById = Object.fromEntries(cfg.videos.map((v) => [v.id, v]));
          });

        // --- Register as game screen ---
        socket.emit("register", { role: "game_screen" });

        // --- Game state listener ---
        socket.on("gameState", async (state) => {
          lastGameState = state;
          const videoConfig = videosById[state.video.id];
          if (!videoConfig) return;

          await applyVideoState(state.video, videoConfig);
          updatePlayersList(state);
          applySubtitles();
        });

        // --- Apply video state safely ---
        async function applyVideoState(videoState, videoConfig) {
          if (lastAppliedVideoState.index !== videoState.index) {
            lastAppliedVideoState = { ...videoState };
            applyingRemoteChange = true;
            video.src = videoConfig.path;
            video.load();
            try {
              await video.play().catch(() => {});
            } finally {
              applyingRemoteChange = false;
            }
            return;
          }

          // Si la vidéo a dépassé sa durée, force pause et set time = duration
          if (videoState.time >= videoState.duration) {
            applyingRemoteChange = true;
            video.pause();
            video.currentTime = videoState.duration;
            applyingRemoteChange = false;
            return; // stop further sync
          }

          // Play / pause
          if (videoState.playing && video.paused) {
            applyingRemoteChange = true;
            await video.play().catch(() => {});
            applyingRemoteChange = false;
          }

          if (!videoState.playing && !video.paused) {
            applyingRemoteChange = true;
            video.pause();
            applyingRemoteChange = false;
          }

          // Sync time if différence > 0.4s
          if (Math.abs(video.currentTime - videoState.time) > 0.4) {
            applyingRemoteChange = true;
            video.currentTime = videoState.time;
            applyingRemoteChange = false;
          }

          lastAppliedVideoState = { ...videoState };
        }

        // --- Players list ---
        function updatePlayersList(state) {
          const players = state.players;
          playersList.innerHTML = Object.entries(players)
            .map(
              ([id, player]) => `
        <div class="playerItem ${player.submitted ? "submitted" : ""} ${
                state.selectedPlayerId === id ? "selected" : ""
              }">
          <span>${player.name}</span>
          <span>${player.submitted ? "✅" : "❌"}</span>
        </div>
      `
            )
            .join("");
        }

        // --- Timeupdate ---
        video.addEventListener("timeupdate", () => {
          if (applyingRemoteChange) return;

          if (video.currentTime >= video.duration) {
            video.pause();
            video.currentTime = video.duration;
            return;
          }

          const now = Date.now();
          if (!video._lastTimeSent || now - video._lastTimeSent > 200) {
            video._lastTimeSent = now;
            socket.emit("videoTimeUpdate", video.currentTime);
          }

          applySubtitles();
        });

        video.addEventListener("loadedmetadata", () => {
          socket.emit("videoDurationUpdate", video.duration);
        });

        // --- Subtitles ---
        function applySubtitles() {
          if (!lastGameState) return;

          const time = video.currentTime;
          const {
            selectedPlayerId,
            players,
            video: videoState,
          } = lastGameState;
          const videoConfig = videosById[videoState.id];

          let activeSubtitle = null;

          // 1. Joueur sélectionné
          if (selectedPlayerId && players[selectedPlayerId]) {
            activeSubtitle = players[selectedPlayerId].subtitles.find(
              (s) => time >= s.start && time <= s.end
            );
          }

          // 2. Placeholder vidéo
          if (!activeSubtitle && videoConfig?.subtitles) {
            const placeholder = videoConfig.subtitles.find(
              (s) => time >= s.start && time <= s.end
            );
            if (placeholder) activeSubtitle = { text: placeholder.placeholder };
          }

          if (activeSubtitle) {
            subtitleOverlay.textContent = activeSubtitle.text;
            subtitleOverlay.style.display = "block";
          } else {
            subtitleOverlay.style.display = "none";
          }
        }
      };

      main();
    </script>
  </body>
</html>
