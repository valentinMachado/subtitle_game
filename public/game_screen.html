<!DOCTYPE html>
<html>
  <head>
    <title>Écran de Jeu</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background-color: black;
        font-family: Arial, sans-serif;
      }

      #videoContainer {
        width: 100%;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: black;
        position: relative;
      }

      #video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      #subtitleOverlay {
        position: absolute;
        bottom: 15%;
        left: 0;
        right: 0;
        text-align: center;
        color: white;
        text-shadow: 2px 2px 4px black;
        font-size: 28px;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 15px;
        margin: 0 10%;
        border-radius: 10px;
        display: none;
      }

      #playersContainer {
        position: fixed;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 5px;
        max-width: 300px;
        max-height: 80vh;
        overflow-y: auto;
        color: white;
      }

      .playerItem {
        padding: 8px;
        margin: 5px 0;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        cursor: pointer;
      }

      .playerItem.submitted {
        background-color: rgba(76, 175, 80, 0.3);
      }

      .playerItem.selected {
        background-color: rgba(255, 165, 0, 0.5);
      }

      #controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 100;
      }

      button {
        padding: 10px 20px;
        font-size: 16px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div id="videoContainer">
      <video id="video"></video>
      <div id="subtitleOverlay"></div>
    </div>

    <div id="playersContainer">
      <h3>Joueurs connectés</h3>
      <div id="playersList"></div>
    </div>

    <div id="controls">
      <button id="nextButton" style="display: none">Vidéo suivante</button>
    </div>

    <script>
      const subtitleOverlay = document.getElementById("subtitleOverlay");
      const playersList = document.getElementById("playersList");
      const nextButton = document.getElementById("nextButton");
      const video = document.querySelector("video");

      let localPlaying = false;
      video.controls = localPlaying;

      const socket = io();
      socket.emit("register", { role: "game_screen" });
      let currentVideoIndex = null;
      let applyingRemoteChange = false;
      let lastGameState = null;

      socket.on("gameState", (state) => {
        if (!state.video || !state.video.data) return;

        lastGameState = state;

        applyVideoState(state.video);

        updatePlayersList(state);
      });

      function updatePlayersList(state) {
        const playersList = document.getElementById("playersList");
        const players = state.players;

        playersList.innerHTML = Object.entries(players)
          .map(
            ([id, player]) => `
    <div class="playerItem ${player.submitted ? "submitted" : ""} ${
              state.selectedPlayerId === id ? "selected" : ""
            }">
      <span>${player.name}</span>
      <span>${player.submitted ? "✅" : "❌"}</span>
    </div>
  `
          )
          .join("");
      }

      function applyVideoState(videoState) {
        // Changement de vidéo
        if (currentVideoIndex !== videoState.index) {
          currentVideoIndex = videoState.index;
          applyingRemoteChange = true;

          video.src = videoState.data.path; // adapte au champ exact
          video.load();
          return;
        }

        // Seek (avec tolérance)
        const delta = Math.abs(video.currentTime - videoState.time);
        if (delta > 0.3) {
          applyingRemoteChange = true;
          video.currentTime = videoState.time;
        }

        if (!localPlaying) {
          if (videoState.playing && video.paused) {
            applyingRemoteChange = true;
            video.play();
          }
          if (!videoState.playing && !video.paused) {
            applyingRemoteChange = true;
            video.pause();
          }
        }
      }

      video.addEventListener("loadedmetadata", () => {
        socket.emit("videoDurationUpdate", video.duration);
      });
      let lastTimeSent = 0;

      video.addEventListener("timeupdate", () => {
        if (applyingRemoteChange) {
          applyingRemoteChange = false;
          return;
        }

        const now = Date.now();
        if (now - lastTimeSent > 200) {
          lastTimeSent = now;
          socket.emit("videoTimeUpdate", video.currentTime);
        }

        applySubtitles();
      });

      function applySubtitles() {
        if (!lastGameState) return;

        const time = video.currentTime;
        const { video: videoState, selectedPlayerId, players } = lastGameState;

        let activeSubtitle = null;

        // 1. Si un joueur est sélectionné → ses sous-titres
        if (selectedPlayerId && players[selectedPlayerId]) {
          activeSubtitle = players[selectedPlayerId].subtitles.find(
            (s) => time >= s.start && time <= s.end
          );
        }
        // 2. Sinon → placeholders de la vidéo
        else if (videoState.data.subtitles) {
          activeSubtitle = videoState.data.subtitles.find(
            (s) => time >= s.start && time <= s.end
          );

          if (activeSubtitle) {
            activeSubtitle = {
              text: activeSubtitle.placeholder,
            };
          }
        }

        // 3. Affichage
        if (activeSubtitle) {
          subtitleOverlay.textContent = activeSubtitle.text;
          subtitleOverlay.style.display = "block";
        } else {
          subtitleOverlay.style.display = "none";
        }
      }

      // Passe à la vidéo suivante
      nextButton.addEventListener("click", () => {
        socket.emit("nextVideo");
      });
    </script>
  </body>
</html>
